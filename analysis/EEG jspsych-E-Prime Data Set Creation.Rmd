---
title: "EEG jspsych/E-Prime Data Set Creation"
author: "Josh de Leeuw, Prashit Parikh"
date: "December 18, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


The first step in data set creation entailed extracting the necessary information from text filed produced in Net Station. This is seen below. The variables subject number, modality, frequency, software, electrode, amplitude, and time were extracted for each participant in the study. A final data set including all extracted information for each chosen electrode and participant was then produced.


```{r}
library(tidyr)
library(dplyr)

subjects <- c(1:9,11:27,29:30)
conditions <- c('Visual Common', 'Visual Rare', 'Audio Common', 'Audio Rare')
software <- c('ep', 'js')
electrodes.to.include <- c(19, 11, 4, 12, 5, 118, 111, 104, 93, 86, 78, 62, 61, 53, 42, 36, 29, 20, 6, 112, 105, 87, 79, 54, 37, 30, 13, 7, 106, 80, 55, 31, 60, 67, 72, 77, 85, 66, 71, 76, 84, 75)

extract.data <- function(file, subject, condition, software){
  data <- read.delim(paste0('data/eeg/',file), header=F)
  data$V129 <- NULL
  colnames(data) <- 1:128
  data$subject <- subject
  data$modality <- ifelse(grepl('Visual', condition), 'visual', 'audio')
  data$frequency <- ifelse(grepl('Common', condition), 'common', 'rare')
  data$software <- software
  data$time <- -199:800
  data <- data %>% gather("electrode", "amplitude", 1:128) %>% filter(electrode %in% electrodes.to.include)
  return(data)
}
all.data <- NA
pb <- txtProgressBar(max=max(subjects), style=3)
for(s in subjects){
  for(condition in conditions){
    for(sw in software){
      rx <- paste0('.*-0*',s,'-.*',condition,'.*',sw,'.*')
      file <- list.files(path='data/eeg', pattern=rx)
      data <- extract.data(file[1], s, condition, sw)
      if(all(is.na(all.data[1]))){
        all.data <- data
      } else {
        all.data <- rbind(all.data, data)
      }
    }
  }
  setTxtProgressBar(pb, s)
}

write.csv(all.data, file="data/eeg/generated/eeg-subset.csv", row.names = FALSE)
```

Following the creation of this subset (eeg-subset), all electrode-subject pairings were coded to a number and randomized. This was done in order to ensure the elimination of bias when choosing electrodes to study the relationship between jspsyche and e-prime. Therefore, a hashmap was utilized in order to randomize subject/electrode pairings. Finally, both subject and electrode were hidden from the final data table created. This ensured that the experimenters would not chose electrodes favoring one software over another. The code table and coded data set were then utilized in picking which electrodes to consider in analysis.


```{r}
library(readr)
library(dplyr)
library(hashmap)
all.data = read_csv("data/eeg/generated/eeg-subset.csv")
code.table <- expand.grid(sw=c('js', 'ep'), el=1:128)
code.table$combined.code <- NA
for(i in 1:nrow(code.table)){
  code.table[i, 'combined.code'] <- paste0(code.table[i,'sw'], code.table[i, 'el'])
}
code.table$code <- sample(nrow(code.table))
code.lookup <- hashmap(code.table$combined.code, code.table$code)

coded.data <- all.data %>% rowwise() %>% mutate(code = code.lookup[[paste0(software,electrode)]])
# pb <- txtProgressBar(min=0, max=nrow(all.data))
# all.data$code <- NA
# for(i in 1:nrow(all.data)){
#   all.data[i,'code'] <- subset(code.table, sw==all.data[i,]$software & el == all.data[i, ]$electrode)$code
#   if(i%%1000 == 0) {
#     setTxtProgressBar(pb, i)
#   }
# }

coded.data$software <- NULL
coded.data$electrode <- NULL

write_csv(code.table, "data/eeg/generated/eeg-code-table.csv")
write_csv(coded.data, "data/eeg/generated/eeg-coded.csv")
```